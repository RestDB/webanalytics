(()=>{async function Y(){let e=await fetch("/auth/refreshtoken",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}});if(e.ok)return await e.json();throw new Error("Failed to refresh token")}async function p(e,t={}){let s={...t};t.headers={...t.headers,credentials:"include"};let a=await fetch(e,t);if(a.status===401)try{let n=await Y();return s.headers={...s.headers,credentials:"include"},fetch(e,s)}catch(n){return console.error("Token refresh failed:",n),window.location.href="/auth/login.html"}return a}function U(e){let t={"baidu.com":"Baidu","bing.com":"Bing","duckduckgo.com":"DuckDuckGo","devhunt.org":"DevHunt","facebook.com":"Facebook","github.com":"GitHub","google.com":"Google","instagram.com":"Instagram","linkedin.com":"LinkedIn","pinterest.com":"Pinterest","reddit.com":"Reddit","snapchat.com":"Snapchat","tiktok.com":"TikTok","twitter.com":"X (Twitter)","whatsapp.com":"WhatsApp","yahoo.com":"Yahoo","yandex.ru":"Yandex","youtube.com":"YouTube","t.co":"X (Twitter)","android-app://com.google.android.gm":"Gmail (Android)"};for(let[s,a]of Object.entries(t))if(e.includes(s))return a;return e.replace("https://","")}function C(e,t){return e=e.replace(/^https?:\/\//,""),e=e.replace(/^www\./,""),e=e.replace(/\/$/,""),e.startsWith(t)&&(e=e.substring(t.length)||"/"),e}var y=["codehooks.io","restdb.io"],S="Codehooks Analytics";var w=null;function F(){return{title:S,loading:!0,realtimeUsers:0,period:"day",uniqueUsers:0,totalPageViews:0,signups:0,bounceRate:0,averageSessionDuration:{minutes:0,seconds:0},eventCompletions:0,topPages:[],topReferers:[],topCountries:[],topEvents:[],geoLocCounts:[],graphData:{labels:[],data:[]},deviceTypes:{desktop:0,mobile:0},pageViewsInPeriod:[],domains:y,selectedDomain:y[0],query:{},filters:[],aiassist:{lastUpdated:new Date().toISOString(),ingress:"",recommendations:[],summary:"","key insights":[],"data-driven recommendations":[],"unusual patterns or anomalies or fun facts":[]},showFullReport:!1,async fetchStats(){try{let e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate());t.setHours(24,0,0,0);let s=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())).toISOString(),a=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()+1)).toISOString(),n=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()-1)),u=n.toISOString(),m=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())).toISOString(),R=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()-2)).toISOString(),P=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate())-1).toISOString(),$=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()-1)).toISOString(),v=u,b=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()-7)).toISOString(),M=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()-30)).toISOString(),T=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth()-3,t.getUTCDate())).toISOString(),I=new Date(Date.UTC(t.getUTCFullYear(),0,1)).toISOString(),c="",l="";switch(this.period){case"day":c=s,l=a;break;case"last2days":c=v,l=a;break;case"last7days":c=b,l=a;break;case"last30days":c=M,l=a;break;case"last3months":c=T,l=a;break;case"lastmonth":c=T,l=a;break;case"lastyear":c=I,l=a;break}let g=this.selectedDomain||this.domains[0],k=`/api/aggstats/${c}/${l}?domain=${g}&query=${JSON.stringify(this.query)}`,D=await p(k,{headers:{"Content-Type":"application/json"}});if(!D.ok)throw new Error("Failed to fetch stats data");let r=await D.json();this.fetchAIAssistData(`/api/aiassist?domain=${g}`),w&&clearInterval(w),this.fetchRealtimeUsers(`/api/activeusers?domain=${g}`),w=setInterval(()=>{this.fetchRealtimeUsers(`/api/activeusers?domain=${g}`)},2e4),this.uniqueUsers=r.uniqueUsers,this.totalPageViews=r.totalPageViews,this.topReferers=r.topReferers.slice(0,10).reduce((o,i)=>{let h=U(i.url),d=o.find(f=>f.brand===h);return d?d.views+=i.views:o.push({url:i.url,brand:h,views:i.views}),o},[]).sort((o,i)=>i.views-o.views).map((o,i)=>({...o,index:i})),this.topCountries=r.topCountries.slice(0,10),this.topEvents=r.topEvents;let A=this.selectedDomain||this.domains[0];this.topPages=r.topPages.reduce((o,i)=>{let h=C(i.url,A),d=o.find(f=>f.url===h);return d?d.views+=i.views:o.push({originalUrl:i.url,url:h,views:i.views}),o},[]).sort((o,i)=>i.views-o.views).slice(0,10),this.locations=r.locations,this.bounceRate=r.bounceRate,this.averageSessionDuration=r.averageSessionDuration,this.eventCompletions=r.totalPageEvents,this.pageViewsInPeriod=r.pageViewsInPeriod,this.graphData={labels:Object.keys(this.pageViewsInPeriod).map(o=>new Date(o)),data:Object.values(this.pageViewsInPeriod)},this.deviceTypes=r.deviceTypes,this.geoLocCounts=r.geoLocCounts.map(o=>({lat:o.geoloc.lat,lon:o.geoloc.lon,count:o.count}))}catch(e){console.error("Error fetching stats:",e)}},async fetchAIAssistData(e){try{let t=await p(e,{headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch AI assist data");let s=await t.json();this.aiassist=s}catch(t){console.error("Error fetching AI assist data:",t)}},async fetchRealtimeUsers(e){try{let t=await p(e,{headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch realtime users data");let s=await t.json();this.realtimeUsers=s.totalActiveUsers}catch(t){console.error("Error fetching realtime users:",t)}},async updateStats(){this.loading=!0;try{await this.fetchStats(),this.initTrafficGraph(),this.initMap()}catch(e){console.error("Error fetching data:",e)}finally{this.loading=!1}},initTrafficGraph(){let e=document.getElementById("traffic-graph");if(!e||!(e instanceof HTMLCanvasElement)){console.error("Traffic graph canvas not found or not a canvas element");return}let t=e.getContext("2d");if(!t){console.error("Unable to get 2D context from canvas");return}this.chartInstance&&this.chartInstance.destroy(),this.chartInstance=new Chart(t,{type:"line",data:{labels:this.graphData.labels,datasets:[{label:"Page Views",data:this.graphData.data,borderWidth:1,fill:!0,pointRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"time",time:{unit:this.getTimeUnit(),displayFormats:{hour:"HH:mm",day:"MMM D",week:"MMM D",month:"MMM YYYY"},tooltipFormat:this.getTooltipFormat(),parser:s=>{let a=new Date(s);return new Date(a.getTime()-a.getTimezoneOffset()*6e4)}},title:{display:!0,text:this.period}},y:{beginAtZero:!0}}}})},getTimeUnit(){switch(this.period){case"day":case"yesterday":return"hour";case"last7days":case"last30days":return"day";case"last3months":case"lastmonth":return"week";case"lastyear":return"month";default:return"day"}},getTooltipFormat(){switch(this.period){case"day":case"yesterday":return"MMM D, HH:mm";case"last7days":case"last30days":case"last3months":case"lastmonth":return"MMM D, YYYY";case"lastyear":return"MMM YYYY";default:return"MMM D, YYYY"}},initMap(){console.log("initMap"),this.mapInstance&&this.mapInstance.remove();var e={radius:1,maxOpacity:.2,scaleRadius:!0,useLocalExtrema:!1,latField:"lat",lngField:"lon",valueField:"count"};let t=new HeatmapOverlay(e),s=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',maxZoom:20,language:"en"});this.mapInstance=new L.Map("world_map",{layers:[s,t],center:[51.5074,-.1278],zoom:3,language:"en"});let a=L.latLngBounds();if(this.geoLocCounts.length>0){let n=L.latLngBounds();this.geoLocCounts.forEach(u=>{let m=L.latLng(u.lat,u.lon);n.extend(m),L.circle(m,{color:"black",fillColor:"#30f",fillOpacity:.1,radius:1e3}).addTo(this.mapInstance)}),t.setData({data:this.geoLocCounts})}},init(){this.updateStats(),this.initTrafficGraph(),this.initMap()},setPageFilter(e,t){this.filters.some(a=>a.field===e&&a.value===t)?console.log(`Filter for ${e} = ${t} already exists`):(this.filters.push({field:e,value:t,key:`${this.filters.length+1}`}),console.log(`Setting page filter for: ${e} = ${t}`),this.query=this.filters.reduce((a,n)=>(a[n.field]=n.value,a),{}),this.updateStats())},removeFilter(e){this.filters=this.filters.filter(t=>t.field!==e.field||t.value!==e.value),this.query=this.filters.reduce((t,s)=>(t[s.field]=s.value,t),{}),this.updateStats()},hasAdditionalContent(){return this.aiassist.summary||this.aiassist.recommendations&&this.aiassist.recommendations.length>0||this.aiassist["key insights"]&&this.aiassist["key insights"].length>0||this.aiassist["data-driven recommendations"]&&this.aiassist["data-driven recommendations"].length>0||this.aiassist["unusual patterns or anomalies or fun facts"]&&this.aiassist["unusual patterns or anomalies or fun facts"].length>0}}}window.dashboard=F;})();
