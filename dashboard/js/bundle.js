(()=>{async function A(){let e=await fetch("/auth/refreshtoken",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}});if(e.ok)return await e.json();throw new Error("Failed to refresh token")}async function m(e,t={}){let s={...t};t.headers={...t.headers,credentials:"include"};let a=await fetch(e,t);if(a.status===401)try{let i=await A();return s.headers={...s.headers,credentials:"include"},fetch(e,s)}catch(i){return console.error("Token refresh failed:",i),window.location.href="/auth/login.html"}return a}function S(e){let t={"baidu.com":"Baidu","bing.com":"Bing","duckduckgo.com":"DuckDuckGo","devhunt.org":"DevHunt","facebook.com":"Facebook","github.com":"GitHub","google.com":"Google","instagram.com":"Instagram","linkedin.com":"LinkedIn","pinterest.com":"Pinterest","reddit.com":"Reddit","snapchat.com":"Snapchat","tiktok.com":"TikTok","twitter.com":"X (Twitter)","whatsapp.com":"WhatsApp","yahoo.com":"Yahoo","yandex.ru":"Yandex","youtube.com":"YouTube","t.co":"X (Twitter)","android-app://com.google.android.gm":"Gmail (Android)"};for(let[s,a]of Object.entries(t))if(e.includes(s))return a;return e.replace("https://","")}function U(e,t){return e=e.replace(/^https?:\/\//,""),e=e.replace(/^www\./,""),e=e.replace(/\/$/,""),e.startsWith(t)&&(e=e.substring(t.length)||"/"),e}var y=["codehooks.io","restdb.io"],C="Codehooks Analytics";var D=null;function Y(){return{title:C,loading:!0,realtimeUsers:0,period:"day",uniqueUsers:0,totalPageViews:0,signups:0,bounceRate:0,averageSessionDuration:{minutes:0,seconds:0},eventCompletions:0,topPages:[],topReferers:[],topCountries:[],topEvents:[],geoLocCounts:[],pageViewsGraphData:{labels:[],data:[]},uniqueSessionsGraphData:{labels:[],data:[]},uniqueEventsGraphData:{labels:[],data:[]},deviceTypes:{desktop:0,mobile:0},pageViewsInPeriod:[],domains:y,selectedDomain:y[0],query:{},filters:[],aiassist:{lastUpdated:new Date().toISOString(),ingress:"",recommendations:[],summary:"","key insights":[],"data-driven recommendations":[],"unusual patterns or anomalies or fun facts":[]},showFullReport:!1,async fetchStats(){try{let e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate());t.setHours(24,0,0,0);let s=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())).toISOString(),a=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()+1)).toISOString(),i=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()-1)),l=i.toISOString(),d=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())).toISOString(),R=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()-2)).toISOString(),P=new Date(Date.UTC(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate())-1).toISOString(),G=new Date(Date.UTC(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate()-1)).toISOString(),b=l,v=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()-7)).toISOString(),I=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()-30)).toISOString(),w=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth()-3,t.getUTCDate())).toISOString(),M=new Date(Date.UTC(t.getUTCFullYear(),0,1)).toISOString(),c="",h="";switch(this.period){case"day":c=s,h=a;break;case"last2days":c=b,h=a;break;case"last7days":c=v,h=a;break;case"last30days":c=I,h=a;break;case"last3months":c=w,h=a;break;case"lastmonth":c=w,h=a;break;case"lastyear":c=M,h=a;break}let p=this.selectedDomain||this.domains[0],k=`/api/aggstats/${c}/${h}?domain=${p}&query=${JSON.stringify(this.query)}`,T=await m(k,{headers:{"Content-Type":"application/json"}});if(!T.ok)throw new Error("Failed to fetch stats data");let o=await T.json();this.fetchAIAssistData(`/api/aiassist?domain=${p}`),D&&clearInterval(D),this.fetchRealtimeUsers(`/api/activeusers?domain=${p}`),D=setInterval(()=>{this.fetchRealtimeUsers(`/api/activeusers?domain=${p}`)},2e4),this.uniqueUsers=o.uniqueUsers,this.totalPageViews=o.totalPageViews,this.topReferers=o.topReferers.slice(0,10).reduce((n,r)=>{let u=S(r.url),g=n.find(f=>f.brand===u);return g?g.views+=r.views:n.push({url:r.url,brand:u,views:r.views}),n},[]).sort((n,r)=>r.views-n.views).map((n,r)=>({...n,index:r})),this.topCountries=o.topCountries.slice(0,10),this.topEvents=o.topEvents;let E=this.selectedDomain||this.domains[0];this.topPages=o.topPages.reduce((n,r)=>{let u=U(r.url,E),g=n.find(f=>f.url===u);return g?g.views+=r.views:n.push({originalUrl:r.url,url:u,views:r.views}),n},[]).sort((n,r)=>r.views-n.views).slice(0,10),this.locations=o.locations,this.bounceRate=o.bounceRate,this.averageSessionDuration=o.averageSessionDuration,this.eventCompletions=o.totalPageEvents,this.pageViewsInPeriod=this.fillMissingHours(o.pageViewsInPeriod),this.pageViewsGraphData={labels:Object.keys(this.pageViewsInPeriod).map(n=>new Date(n)),data:Object.values(this.pageViewsInPeriod)},this.uniqueSessionsInPeriod=this.fillMissingHours(o.uniqueSessionsInPeriod),this.uniqueSessionsGraphData={labels:Object.keys(this.uniqueSessionsInPeriod).map(n=>new Date(n)),data:Object.values(this.uniqueSessionsInPeriod)},this.uniqueEventsInPeriod=this.fillMissingHours(o.uniqueEventsInPeriod),this.uniqueEventsGraphData={labels:Object.keys(this.uniqueEventsInPeriod).map(n=>new Date(n)),data:Object.values(this.uniqueEventsInPeriod)},this.deviceTypes=o.deviceTypes,this.geoLocCounts=o.geoLocCounts.map(n=>({lat:n.geoloc.lat,lon:n.geoloc.lon,count:n.count}))}catch(e){console.error("Error fetching stats:",e)}},async fetchAIAssistData(e){try{let t=await m(e,{headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch AI assist data");let s=await t.json();this.aiassist=s}catch(t){console.error("Error fetching AI assist data:",t)}},async fetchRealtimeUsers(e){try{let t=await m(e,{headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch realtime users data");let s=await t.json();this.realtimeUsers=s.totalActiveUsers}catch(t){console.error("Error fetching realtime users:",t)}},async updateStats(){this.loading=!0;try{await this.fetchStats(),this.initTrafficGraph(),this.initMap()}catch(e){console.error("Error fetching data:",e)}finally{this.loading=!1}},initTrafficGraph(){let e=document.getElementById("traffic-graph");if(!e||!(e instanceof HTMLCanvasElement)){console.error("Traffic graph canvas not found or not a canvas element");return}let t=e.getContext("2d");if(!t){console.error("Unable to get 2D context from canvas");return}this.chartInstance&&this.chartInstance.destroy(),this.chartInstance=new Chart(t,{type:"line",data:{labels:this.pageViewsGraphData.labels,datasets:[{label:"Page Views",data:this.pageViewsGraphData.data,borderWidth:1,tension:.1,fill:!0,pointRadius:0},{label:"Unique Users",data:this.uniqueSessionsGraphData.data,borderWidth:1,tension:.1,fill:!0,pointRadius:0},{label:"Unique Events",data:this.uniqueEventsGraphData.data,borderWidth:1,tension:.1,fill:!0,pointRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"time",time:{unit:this.getTimeUnit(),displayFormats:{hour:"HH:mm",day:"MMM D",week:"MMM D",month:"MMM YYYY"},tooltipFormat:this.getTooltipFormat(),parser:s=>{let a=new Date(s);return new Date(a.getTime()-a.getTimezoneOffset()*6e4)}},title:{display:!0,text:this.period}},y:{beginAtZero:!0}}}})},getTimeUnit(){switch(this.period){case"day":case"yesterday":return"hour";case"last7days":case"last30days":return"day";case"last3months":case"lastmonth":return"week";case"lastyear":return"month";default:return"day"}},getTooltipFormat(){switch(this.period){case"day":case"yesterday":return"MMM D, HH:mm";case"last7days":case"last30days":case"last3months":case"lastmonth":return"MMM D, YYYY";case"lastyear":return"MMM YYYY";default:return"MMM D, YYYY"}},initMap(){console.log("initMap"),this.mapInstance&&this.mapInstance.remove();var e={radius:1,maxOpacity:.2,scaleRadius:!0,useLocalExtrema:!1,latField:"lat",lngField:"lon",valueField:"count"};let t=new HeatmapOverlay(e),s=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',maxZoom:20,language:"en"});this.mapInstance=new L.Map("world_map",{layers:[s,t],center:[51.5074,-.1278],zoom:3,language:"en"});let a=L.latLngBounds();if(this.geoLocCounts.length>0){let i=L.latLngBounds();this.geoLocCounts.forEach(l=>{let d=L.latLng(l.lat,l.lon);i.extend(d),L.circle(d,{color:"black",fillColor:"#30f",fillOpacity:.1,radius:1e3}).addTo(this.mapInstance)}),t.setData({data:this.geoLocCounts})}},init(){this.updateStats(),this.initTrafficGraph(),this.initMap()},setPageFilter(e,t){this.filters.some(a=>a.field===e&&a.value===t)?console.log(`Filter for ${e} = ${t} already exists`):(this.filters.push({field:e,value:t,key:`${this.filters.length+1}`}),console.log(`Setting page filter for: ${e} = ${t}`),this.query=this.filters.reduce((a,i)=>(a[i.field]=i.value,a),{}),this.updateStats())},removeFilter(e){this.filters=this.filters.filter(t=>t.field!==e.field||t.value!==e.value),this.query=this.filters.reduce((t,s)=>(t[s.field]=s.value,t),{}),this.updateStats()},hasAdditionalContent(){return this.aiassist.summary||this.aiassist.recommendations&&this.aiassist.recommendations.length>0||this.aiassist["key insights"]&&this.aiassist["key insights"].length>0||this.aiassist["data-driven recommendations"]&&this.aiassist["data-driven recommendations"].length>0||this.aiassist["unusual patterns or anomalies or fun facts"]&&this.aiassist["unusual patterns or anomalies or fun facts"].length>0},fillMissingHours(e){let t={},s=Object.entries(e);if(s.length<2)return e;let a=new Date(s[0][0]),i=new Date(s[s.length-1][0]);for(let l=new Date(a);l<=i;l.setHours(l.getHours()+1)){let d=l.toISOString().slice(0,13)+":00";t[d]=e[d]||0}return t}}}window.dashboard=Y;})();
